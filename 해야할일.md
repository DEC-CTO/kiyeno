# 🚀 Kiyeno 벽체 관리 시스템 개선 로드맵

## 📋 현재 상황 분석

### ✅ 잘 작동하는 부분 (건드리지 말 것)
- `unitPriceManager.js` (3400+ 라인) - 핵심 비즈니스 로직
- 노무비 처리 로직 (최근 수정 완료)
- 6가지 자재 계산 공식 (검증된 로직)
- Revit 연동 기능 (안정적으로 작동 중)
- 3계층 하이브리드 데이터 시스템

### 🔴 주요 문제점
1. **전역 스코프 오염** - window 객체에 함수들 직접 할당
2. **파일 로딩 복잡성** - index.html에 15개+ 파일 개별 로드
3. **의존성 관리** - CDN 의존으로 버전 관리 어려움
4. **onclick 속성** - HTML과 JavaScript 결합도 높음

## 🎯 개선 우선순위

### 🚨 즉시 실행 (위험도: 낮음)
**소요시간: 1-2시간**

1. **파일 정리**
   ```bash
   # QTOForm.cs 이동
   mkdir revit-addon
   mv QTOForm.cs revit-addon/
   
   # .gitignore 생성
   echo "server.log" > .gitignore
   echo "server.pid" >> .gitignore
   echo "node_modules/" >> .gitignore
   echo "dist/" >> .gitignore
   ```

2. **서버 오류 처리 개선**
   ```bash
   npm install express-async-errors
   ```

---

### 🔥 1단계: 빌드 시스템 도입 (위험도: 낮음-중간)
**소요시간: 1-2일**

#### 목표
- 현재 코드 그대로 두고 빌드만 추가
- 개발 편의성 향상 (자동 새로고침)
- 성능 최적화 (번들링, 압축)

#### 작업 내용

1. **Vite 설치 및 설정**
   ```bash
   npm install -D vite
   npm install dexie xlsx socket.io-client
   ```

2. **package.json 스크립트 추가**
   ```json
   {
     "scripts": {
       "dev": "vite",
       "build": "vite build",
       "preview": "vite preview"
     }
   }
   ```

3. **vite.config.js 생성**
   - Express 서버와 연동 설정
   - 프록시 설정으로 API 호출 연결

4. **CDN → npm 의존성 전환**
   - Font Awesome, SheetJS, Dexie, Socket.IO
   - index.html에서 CDN 링크 제거

5. **테스트**
   - `npm run dev` 실행
   - 모든 기능 정상 작동 확인
   - `npm run build` 실행하여 배포용 빌드 생성

#### 기대 효과
- ⚡ 로딩 속도 3-5배 향상
- 🔄 개발 중 자동 새로고침
- 📦 의존성 관리 자동화
- 🗜️ 파일 크기 30-50% 감소

---

### ⚡ 2단계: WebSocket 통합 (위험도: 중간)
**소요시간: 1-2일**

#### 현재 문제
- `server.js`에서 Socket.IO + ws 두 개 라이브러리 동시 사용
- 불필요한 복잡성과 브릿징 로직

#### 해결 방안
1. **Socket.IO Namespace 활용**
   ```javascript
   // 웹 클라이언트용
   const webNamespace = io.of('/web');
   
   // Revit 애드인용  
   const revitNamespace = io.of('/revit');
   ```

2. **ws 라이브러리 제거**
   - 모든 통신을 Socket.IO로 통합
   - server.js 코드 단순화

#### 주의사항
- C# Revit 애드인 코드도 함께 수정 필요
- WebSocket 통신 프로토콜 변경 시 양쪽 모두 테스트

---

### 🔧 3단계: 점진적 모듈화 (위험도: 중간-높음)
**소요시간: 1-2주**

#### 전략: "새로운 것부터 모듈화"
- 기존 코드는 그대로 유지
- 새로운 기능만 ES6 모듈로 작성
- 점진적으로 전환

#### 작업 순서

1. **새로운 기능 모듈화**
   - 새로 추가되는 기능부터 ES6 모듈 사용
   - export/import 방식 적용

2. **전역 함수 정리**
   ```javascript
   // 현재: window.openRevitTypeMatching = function() {...}
   // 변경: export function openRevitTypeMatching() {...}
   ```

3. **onclick → addEventListener 전환**
   ```javascript
   // HTML에서 제거: onclick="myFunction()"
   // JS에서 추가: element.addEventListener('click', myFunction);
   ```

4. **index.html 인라인 스크립트 제거**
   - 거대한 `<script>` 블록을 별도 파일로 분리
   - 의존성 순서 정리

#### ⚠️ 절대 건드리지 말 것
- `unitPriceManager.js` 전체 구조
- 노무비 처리 로직
- 계산 공식들
- Revit 연동 핵심 로직

---

### 🧪 4단계: 테스트 도입 (우선순위: 낮음)
**소요시간: 1주**

#### 목표
- 핵심 계산 로직에 대한 단위 테스트
- 회귀 테스트 방지

#### 작업 내용
1. **Jest 또는 Vitest 설치**
2. **계산 함수 테스트**
   - 스터드, 런너, 피스 계산
   - 노무비 처리 로직
   - 석고피스 계산

---

## 📅 권장 실행 일정

### Week 1: 기반 작업
- [x] 파일 정리 (즉시)
- [ ] Vite 빌드 시스템 도입
- [ ] CDN → npm 전환
- [ ] 기능 테스트

### Week 2: 최적화
- [ ] WebSocket 통합
- [ ] 성능 측정 및 개선
- [ ] 배포 프로세스 정리

### Week 3-4: 점진적 개선 (선택사항)
- [ ] 새로운 기능부터 모듈화
- [ ] 전역 함수 정리
- [ ] onclick 속성 제거

## 🎯 핵심 원칙

### ✅ DO (해야 할 것)
- **"동작하는 코드는 건드리지 않기"**
- 성능과 관리성 개선에만 집중
- 점진적이고 안전한 변경
- 각 단계마다 철저한 테스트

### ❌ DON'T (하지 말 것)
- unitPriceManager.js 대대적 리팩토링
- 검증된 비즈니스 로직 변경
- 한 번에 모든 것 바꾸기
- 사용자 경험 변경

## 📊 성공 지표

### 1단계 완료 후
- [ ] 로딩 속도 50% 이상 개선
- [ ] 개발 시 자동 새로고침 작동
- [ ] 모든 기능 정상 작동

### 2단계 완료 후  
- [ ] WebSocket 연결 안정성 향상
- [ ] server.js 코드 50% 이상 단순화

### 3단계 완료 후
- [ ] 새로운 기능 추가 시 모듈 방식 사용
- [ ] 전역 스코프 오염 80% 이상 감소

## 💡 결론

**"빠르게 시작하고, 점진적으로 개선하자"**

서비스 시작 전이라는 절호의 기회를 활용하여, 기존의 안정적인 비즈니스 로직은 보존하면서 기술적 기반을 현대화하는 것이 목표입니다.

특히 빌드 시스템 도입만으로도 개발 경험과 성능이 크게 개선되므로, 1단계부터 착실히 진행하는 것을 강력히 추천합니다! 🚀