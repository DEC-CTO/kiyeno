<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë²½ì²´ ì •ë³´ ê´€ë¦¬ ì‹œìŠ¤í…œ - Wall Management System</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/breakdown-styles.css" />
    <link rel="stylesheet" href="css/material-management.css" />
    <link rel="stylesheet" href="css/material-selector.css" />
    <link rel="stylesheet" href="css/revit-responsive.css" />
    <link rel="stylesheet" href="css/display-system.css" />

    <!-- Dexie.js for IndexedDB management -->
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>

    <!-- Socket.IO Client for WebSocket communication -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  </head>
  <body>
    <div class="container">
      <!-- ìƒë‹¨ ë©”ì¸ ì»¨í…ì¸  -->
      <div class="main-content">
        <!-- í—¤ë” -->
        <div class="header">
          <h1><i class="fas fa-building"></i> Kiyeno ë²½ì²´ ì •ë³´ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
        </div>

        <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ -->
        <div class="controls">
          <!-- ê²°ê³¼ë¬¼ ë””ìŠ¤í”Œë ˆì´ ì‹œìŠ¤í…œ -->
          <div class="display-mode-dropdown">
            <button
              class="display-mode-button"
              id="displayModeButton"
              onclick="toggleDisplayModeDropdown()"
            >
              <i class="fas fa-list-alt"></i>
              ê¸°ë³¸ê°’ë³´ê¸°
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="display-mode-dropdown-menu" id="displayModeDropdown">
              <div
                class="display-mode-dropdown-item active"
                onclick="DisplaySystem.setMode('default'); toggleDisplayModeDropdown()"
              >
                <i class="fas fa-list-alt"></i>
                ê¸°ë³¸ê°’ë³´ê¸°
              </div>
              <div
                class="display-mode-dropdown-item"
                onclick="DisplaySystem.setMode('type'); toggleDisplayModeDropdown()"
              >
                <i class="fas fa-layer-group"></i>
                íƒ€ì…ë³„ë³´ê¸°
              </div>
              <div
                class="display-mode-dropdown-item"
                onclick="DisplaySystem.setMode('material'); toggleDisplayModeDropdown()"
              >
                <i class="fas fa-box"></i>
                ì¬ë£Œë³„ë³´ê¸°
              </div>
              <div
                class="display-mode-dropdown-item"
                onclick="DisplaySystem.setMode('workType'); toggleDisplayModeDropdown()"
              >
                <i class="fas fa-hard-hat"></i>
                ê³µì¢…ë³„ë³´ê¸°
              </div>
            </div>
          </div>

          <!-- ìì¬ ê´€ë¦¬ ë²„íŠ¼ -->
          <button
            class="btn btn-green"
            id="materialManageBtn"
            onclick="showMaterialManageModal()"
          >
            <i class="fas fa-tools"></i> ìì¬ ê´€ë¦¬
          </button>

          <!-- ë²½ì²´ íƒ€ì… ê´€ë¦¬ ë²„íŠ¼ -->
          <button
            class="btn btn-purple"
            id="wallTypeManageBtn"
            onclick="openRevitTypeMatching()"
          >
            <i class="fas fa-layer-group"></i> ë²½ì²´ íƒ€ì… ê´€ë¦¬
          </button>

          <!-- ì¼ìœ„ëŒ€ê°€ ê´€ë¦¬ ë²„íŠ¼ -->
          <button
            class="btn btn-orange"
            id="unitPriceManageBtn"
            onclick="openUnitPriceManagement()"
          >
            <i class="fas fa-calculator"></i> ì¼ìœ„ëŒ€ê°€ ê´€ë¦¬
          </button>

          <!-- Revit ì—°ë™ ë©”ë‰´ -->
          <div class="dropdown">
            <button
              class="btn btn-purple dropdown-toggle"
              onclick="toggleDropdown('revitIntegration')"
            >
              <i class="fas fa-cube"></i> Revit ì—°ë™
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="dropdown-menu" id="revitIntegration">
              <div
                class="dropdown-item wall-selection-button"
                onclick="selectSingleWallFromRevit()"
              >
                <i class="fas fa-mouse-pointer"></i> ë²½ì²´ ì„ íƒ (ë‹¨ì¼)
              </div>
              <div
                class="dropdown-item wall-selection-button"
                onclick="selectMultipleWallsFromRevit()"
              >
                <i class="fas fa-hand-pointer"></i> ë²½ì²´ ì„ íƒ (ë‹¤ì¤‘)
              </div>
              <div
                class="dropdown-item wall-selection-button"
                onclick="selectWallsByRoomFromRevit()"
              >
                <i class="fas fa-home"></i> ë£¸ìœ¼ë¡œ ë²½ì²´ì„ íƒ
              </div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-item" onclick="createWallTypesInRevit()">
                <i class="fas fa-hammer"></i> WallType ìƒì„±
              </div>
              <div class="dropdown-divider"></div>
              <div
                class="dropdown-item"
                onclick="toggleRevitDataSection()"
                id="revitToggleBtn"
              >
                <i class="fas fa-table"></i> Revit ë°ì´í„° ì—´ê¸°/ë‹«ê¸°
              </div>
            </div>
          </div>
        </div>

        <!-- ë””ìŠ¤í”Œë ˆì´ ì»¨í…Œì´ë„ˆ -->
        <div class="display-container" id="displayContainer">
          <!-- ë””ìŠ¤í”Œë ˆì´ ë‚´ìš©ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
        </div>
      </div>
      <!-- main-content ë‹«ê¸° -->

      <!-- Revit ë°ì´í„° í™•ì¸ í…Œì´ë¸” (ìˆ¨ê¹€ ìƒíƒœë¡œ ì‹œì‘) -->
      <div
        id="revitDataSection"
        class="revit-data-section"
        style="display: none"
      >
        <div class="revit-header">
          <h2><i class="fas fa-cube"></i> Revit ë²½ì²´ ë°ì´í„° í™•ì¸</h2>
          <div class="revit-controls">
            <div class="dropdown">
              <button
                class="btn btn-primary dropdown-toggle"
                type="button"
                id="exportImportDropdown"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
              >
                <i class="fas fa-download"></i> ë°ì´í„° ê´€ë¦¬
              </button>
              <div class="dropdown-menu" aria-labelledby="exportImportDropdown">
                <a class="dropdown-item" href="#" onclick="exportToExcel()">
                  <i class="fas fa-file-excel"></i> Excelë¡œ ë‚´ë³´ë‚´ê¸°
                </a>
                <a class="dropdown-item" href="#" onclick="exportToJSON()">
                  <i class="fas fa-file-code"></i> JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#" onclick="importFromFile()">
                  <i class="fas fa-upload"></i> íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
                </a>
              </div>
            </div>
            <button class="btn btn-secondary" onclick="clearRevitData()">
              <i class="fas fa-trash"></i> Revit ë°ì´í„° ì§€ìš°ê¸°
            </button>
          </div>
        </div>

        <!-- íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ìœ„í•œ ìˆ¨ê²¨ì§„ input -->
        <input
          type="file"
          id="fileImportInput"
          accept=".json,.xlsx,.xls"
          style="display: none"
          onchange="handleFileImport(event)"
        />

        <div class="revit-table-wrapper">
          <div class="revit-selection-info">
            <span id="revitSelectionText">Revit ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
            <div style="font-size: 10px; color: #666; margin-top: 5px">
              <i class="fas fa-info-circle"></i> ì„ íƒ ë°©ë²•: ì¼ë°˜ í´ë¦­(ë‹¨ì¼),
              Ctrl+í´ë¦­(ë‹¤ì¤‘), Shift+í´ë¦­(ë²”ìœ„)
            </div>
          </div>

          <!-- í•„í„° ì»¨íŠ¸ë¡¤ -->
          <div class="revit-filters">
            <div class="filter-group">
              <label for="nameFilter"
                ><i class="fas fa-filter"></i> Name í•„í„°:</label
              >
              <select id="nameFilter" onchange="applyRevitFilters()">
                <option value="">ì „ì²´</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="levelFilter"
                ><i class="fas fa-filter"></i> Level í•„í„°:</label
              >
              <select id="levelFilter" onchange="applyRevitFilters()">
                <option value="">ì „ì²´</option>
              </select>
            </div>
            <div class="filter-group">
              <button
                class="btn btn-sm btn-secondary"
                onclick="clearRevitFilters()"
              >
                <i class="fas fa-times"></i> í•„í„° ì´ˆê¸°í™”
              </button>
            </div>
            <div class="filter-group">
              <button class="btn btn-sm btn-info" onclick="selectInRevit()">
                <i class="fas fa-crosshairs"></i> Revit ê°ì²´ ì„ íƒ
              </button>
            </div>
          </div>

          <div class="revit-table-container">
            <table class="revit-table">
              <thead>
                <tr>
                  <th class="col-select">
                    <input
                      type="checkbox"
                      id="revitSelectAll"
                      onchange="toggleAllRevitSelection()"
                    />
                  </th>
                  <th class="col-revit-id">Revit ID</th>
                  <th class="col-revit-name">Name</th>
                  <th class="col-revit-length">Length (m)</th>
                  <th class="col-revit-area">Area (mÂ²)</th>
                  <th class="col-revit-height">Height (m)</th>
                  <th class="col-revit-thickness">Thickness (m)</th>
                  <th class="col-revit-level">Level</th>
                  <th class="col-revit-category">Category</th>
                  <th class="col-revit-roomname">ì‹¤ëª… (Room)</th>
                </tr>
              </thead>
              <tbody id="revitTableBody">
                <!-- Revit ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- container ë‹«ê¸° -->

    <!-- ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ -->
    <div id="contextMenu" class="context-menu">
      <div class="context-menu-item" onclick="duplicateWall()">
        <i class="fas fa-copy"></i> ë²½ì²´ ë³µì‚¬
      </div>
      <div class="context-menu-item" onclick="deleteWall()">
        <i class="fas fa-trash-alt"></i> ë²½ì²´ ì‚­ì œ
      </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
    <div id="toast" class="toast">
      <div id="toastMessage"></div>
    </div>

    <!-- ì„ íƒ ì •ë³´ -->
    <div id="selectionInfo" class="selection-info">
      <span id="selectionText"></span>
    </div>

    <!-- ì‹¤ëª… ì…ë ¥ ëª¨ë‹¬ -->
    <div id="roomNameModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-home"></i> ì‹¤ëª… ì…ë ¥</h3>
          <span class="close" onclick="closeRoomNameModal()">&times;</span>
        </div>
        <div class="modal-body">
          <p>ì„ íƒëœ ë²½ì²´ì˜ ì‹¤ëª…(ë£¸ ì´ë¦„)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:</p>
          <div class="wall-info" id="modalWallInfo">
            <!-- ë²½ì²´ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
          </div>
          <div class="input-group">
            <label for="roomNameInput">ì‹¤ëª…:</label>
            <input
              type="text"
              id="roomNameInput"
              placeholder="ì˜ˆ: ê±°ì‹¤, ì¹¨ì‹¤1, ì£¼ë°©..."
              maxlength="50"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeRoomNameModal()">
            <i class="fas fa-times"></i> ì·¨ì†Œ
          </button>
          <button class="btn btn-success" onclick="saveRoomName()">
            <i class="fas fa-save"></i> ì €ì¥
          </button>
        </div>
      </div>
    </div>

    <!-- Kiyeno ë²½ì²´ ê´€ë¦¬ ì‹œìŠ¤í…œ - í†µí•© ëª¨ë“ˆ -->
    <!-- ë¸Œë¦¿ì§€ ì‹œìŠ¤í…œ - ìƒˆë¡œìš´ ì‹œìŠ¤í…œê³¼ ê¸°ì¡´ ì‹œìŠ¤í…œ ì—°ê²° -->
    <script src="js/bridge.js"></script>
    <!-- priceDatabaseë¥¼ ë¨¼ì € ë¡œë“œí•˜ì—¬ ì „ì—­ì— ë…¸ì¶œ -->
    <script type="module">
      import priceDatabase from './js/modules/priceDatabase.js';
      window.priceDatabase = priceDatabase;
      window.priceDB = priceDatabase;
      await priceDatabase.initialize();
      console.log('ğŸš€ priceDatabase ì „ì—­ ì´ˆê¸°í™” ì™„ë£Œ');
    </script>
    <!-- ES6 ëª¨ë“ˆ ì‹œìŠ¤í…œ -->
    <script type="module" src="js/main.js"></script>
    <script src="js/app-core.js"></script>
    <script src="js/app-calculator.js"></script>
    <script src="js/app-services.js"></script>
    <script src="js/app-ui.js"></script>
    <script src="js/revit-type-matching.js"></script>
    <script src="js/revit-wall-handler.js"></script>
    <script src="js/display-system.js"></script>

    <!-- í†µí•© JavaScript ì´ˆê¸°í™” ì‹œìŠ¤í…œ -->
    <script>
      // ë°±ì—…ìš© í•¨ìˆ˜ ì •ì˜ (íŒŒì¼ì—ì„œ ë¡œë“œë˜ì§€ ì•Šì„ ê²½ìš°ë¥¼ ëŒ€ë¹„)
      if (typeof window.selectSingleWallFromRevit !== 'function') {
        window.selectSingleWallFromRevit = function () {
          console.log('ë°±ì—… selectSingleWallFromRevit í•¨ìˆ˜ í˜¸ì¶œë¨');
          // WebSocketì„ í†µí•œ Revit í†µì‹ 
          if (window.socketService && window.socketService.isConnected()) {
            window.socketService.sendRevitCommand('selectWall');
            if (typeof showToast === 'function') {
              showToast('ğŸ–±ï¸ Revitì—ì„œ ë²½ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'info');
            } else {
              alert('Revitì—ì„œ ë²½ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }
          } else {
            alert('Revit ì—°ë™ í™˜ê²½ì´ ì•„ë‹™ë‹ˆë‹¤. WebSocket ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          }
        };
      }

      if (typeof window.selectMultipleWallsFromRevit !== 'function') {
        window.selectMultipleWallsFromRevit = function () {
          console.log('ë°±ì—… selectMultipleWallsFromRevit í•¨ìˆ˜ í˜¸ì¶œë¨');
          // WebSocketì„ í†µí•œ Revit í†µì‹ 
          if (window.socketService && window.socketService.isConnected()) {
            window.socketService.sendRevitCommand('selectMultipleWalls');
            if (typeof showToast === 'function') {
              showToast(
                'ğŸ–±ï¸ Revitì—ì„œ ë²½ì²´ë“¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”. (ì™„ë£Œí•˜ë ¤ë©´ Finish í´ë¦­)',
                'info'
              );
            } else {
              alert(
                'Revitì—ì„œ ë²½ì²´ë“¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”. (ì™„ë£Œí•˜ë ¤ë©´ Finish í´ë¦­)'
              );
            }
          } else {
            alert('Revit ì—°ë™ í™˜ê²½ì´ ì•„ë‹™ë‹ˆë‹¤. WebSocket ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          }
        };
      }

      if (typeof window.addWallsFromRevit !== 'function') {
        window.addWallsFromRevit = function (wallInfos) {
          console.log('ë°±ì—… addWallsFromRevit í•¨ìˆ˜ í˜¸ì¶œë¨', wallInfos);

          // ê¸°ë³¸ì ì¸ ë°ì´í„° í‘œì‹œ
          if (wallInfos && Array.isArray(wallInfos) && wallInfos.length > 0) {
            const revitSection = document.getElementById('revitDataSection');
            if (revitSection) {
              revitSection.style.display = 'flex';
              revitSection.scrollIntoView({ behavior: 'smooth' });
            }

            // ê°„ë‹¨í•œ í…Œì´ë¸” ë Œë”ë§
            const tableBody = document.getElementById('revitTableBody');
            if (tableBody) {
              tableBody.innerHTML = '';
              wallInfos.forEach((wall, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                              <td><input type="checkbox"></td>
                              <td>${wall.Id || wall.id || 'N/A'}</td>
                              <td>${wall.Name || wall.name || 'N/A'}</td>
                              <td>${
                                wall.WallType || wall.wallType || 'N/A'
                              }</td>
                              <td>${(wall.Area || wall.area || 0).toFixed(
                                3
                              )}</td>
                              <td>${(wall.Height || wall.height || 0).toFixed(
                                3
                              )}</td>
                              <td>${(wall.Length || wall.length || 0).toFixed(
                                3
                              )}</td>
                              <td>${(
                                wall.Thickness ||
                                wall.thickness ||
                                0
                              ).toFixed(3)}</td>
                              <td>${wall.Level || wall.level || 'N/A'}</td>
                              <td>${
                                wall.Material || wall.material || 'N/A'
                              }</td>
                              <td>${wall.Comments || wall.comments || '-'}</td>
                          `;
                tableBody.appendChild(row);
              });
            }

            const message = `Revitì—ì„œ ${wallInfos.length}ê°œ ë²½ì²´ ë°ì´í„°ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.`;
            if (typeof showToast === 'function') {
              showToast(message, 'success');
            } else {
              alert(message);
            }

            console.log('ë°›ì€ ë²½ì²´ ë°ì´í„°:', wallInfos);
          } else {
            alert('ìœ íš¨í•œ ë²½ì²´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          }
        };
      }

      // ë°±ì—… í•¨ìˆ˜ë“¤ - ë©”ì¸ í•¨ìˆ˜ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
      console.log('HTML ë°±ì—… í•¨ìˆ˜ ì²´í¬ ì‹œì ì˜ í•¨ìˆ˜ ìƒíƒœ:', {
        clearRevitData: typeof window.clearRevitData,
        toggleAllRevitSelection: typeof window.toggleAllRevitSelection,
        toggleRevitSelection: typeof window.toggleRevitSelection,
      });

        if (typeof window.clearRevitData !== 'function') {
          console.warn('clearRevitData ë©”ì¸ í•¨ìˆ˜ ì—†ìŒ - ë°±ì—… í•¨ìˆ˜ ë“±ë¡');
          window.clearRevitData = function () {
            console.log('ë°±ì—… clearRevitData í•¨ìˆ˜ í˜¸ì¶œë¨');
            if (confirm('Revit ë°ì´í„°ë¥¼ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              const revitSection = document.getElementById('revitDataSection');
              if (revitSection) {
                revitSection.style.display = 'none';
              }
              const tableBody = document.getElementById('revitTableBody');
              if (tableBody) {
                tableBody.innerHTML =
                  '<tr><td colspan="11" style="text-align: center; padding: 20px;">Revit ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</td></tr>';
              }
              alert('Revit ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
          };
        }

        if (typeof window.toggleAllRevitSelection !== 'function') {
          console.warn(
            'toggleAllRevitSelection ë©”ì¸ í•¨ìˆ˜ ì—†ìŒ - ë°±ì—… í•¨ìˆ˜ ë“±ë¡'
          );
          window.toggleAllRevitSelection = function () {
            console.log('ë°±ì—… toggleAllRevitSelection í•¨ìˆ˜ í˜¸ì¶œë¨');
            const checkboxes = document.querySelectorAll(
              '#revitTableBody input[type="checkbox"]'
            );
            const selectAll = document.getElementById('revitSelectAll');
            const isChecked = selectAll ? selectAll.checked : false;

            checkboxes.forEach((checkbox) => {
              checkbox.checked = isChecked;
            });
          };
        }

        if (typeof window.toggleRevitSelection !== 'function') {
          console.warn('toggleRevitSelection ë©”ì¸ í•¨ìˆ˜ ì—†ìŒ - ë°±ì—… í•¨ìˆ˜ ë“±ë¡');
          window.toggleRevitSelection = function (tempId, checked) {
            console.log(
              'ë°±ì—… toggleRevitSelection í•¨ìˆ˜ í˜¸ì¶œë¨',
              tempId,
              checked
            );
            // ê¸°ë³¸ì ì¸ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½ë§Œ ì²˜ë¦¬
          };
        }
      }, 50);

      }, 100);




      console.log('HTML ë°±ì—… í•¨ìˆ˜ ì •ì˜ ì™„ë£Œ:', {
        selectSingleWallFromRevit: typeof window.selectSingleWallFromRevit,
        selectMultipleWallsFromRevit:
          typeof window.selectMultipleWallsFromRevit,
        addWallsFromRevit: typeof window.addWallsFromRevit,
        clearRevitData: typeof window.clearRevitData,
        toggleAllRevitSelection: typeof window.toggleAllRevitSelection,
        toggleRevitSelection: typeof window.toggleRevitSelection,
      });
    </script>
  </body>
</html>
