# 엑셀 일위대가 로드 및 두 방식 통합 구현 계획

## 개요

외부 단가표(Excel)를 로드하여 간소화된 일위대가로 저장하고, 기존 상세 일위대가 방식과 함께 사용할 수 있는 시스템 구현

---

## 핵심 요구사항

1. **엑셀 데이터 = 일위대가** (1row = 1개 간소화 일위대가)
2. **DB 저장 및 업데이트**: 엑셀 재업로드 시 기존 데이터 업데이트 (key 기준)
3. **데이터 확인 UI**: 모달 또는 모드리스 폼으로 조회/수정/삭제
4. **벽체타입관리 연동**: 엑셀 일위대가 또는 기존 상세 일위대가 선택 가능
5. **혼합 불가**: 한 벽체타입 내에서는 단일 방식만 사용
6. **Revit 벽체타입 생성**: 엑셀 데이터 기반으로 생성 가능
7. **결과물**: 단가비교표 (기존 형식), 발주서 상세는 엑셀 방식에서 제외

---

## UX/UI 디자인

### 설계 원칙: 완벽 분리

두 방식(상세 일위대가 vs 엑셀 간소화)은 **완전히 분리된 UI 영역**으로 구성합니다.

**분리 이유**:
1. **혼란 방지**: 두 방식은 근본적으로 다른 데이터 구조 (상세 구성품 vs 단순 금액)
2. **워크플로우 분리**: 엑셀 방식 사용자는 기존 일위대가관리를 사용할 필요 없음
3. **명확한 선택**: 프로젝트 시작 시 어떤 방식을 사용할지 명확히 선택 가능

### 메인 화면 버튼 배치 (완벽 분리)

```
┌─────────────────────────────────────────────────────────────────┐
│  ▸ 상세 일위대가 방식                                            │
│    [자재 관리]  [벽체 타입 관리]  [일위대가 관리]                │
├─────────────────────────────────────────────────────────────────┤
│  ▸ 간소화 방식 (엑셀 단가표)                                     │
│    [엑셀 단가표 관리]  [엑셀 벽체타입 관리]                      │
└─────────────────────────────────────────────────────────────────┘
```

**구현 방법**:
- 기존 버튼 3개 위에 "상세 일위대가 방식" 라벨 추가
- 구분선 또는 시각적 분리 요소 추가
- "간소화 방식" 라벨과 함께 **2개 버튼** 추가:
  - [엑셀 단가표 관리]: 엑셀 일위대가 업로드/조회
  - [엑셀 벽체타입 관리]: 엑셀 일위대가 기반 벽체타입 생성/관리

**완벽 분리 원칙**:
- 기존 [벽체 타입 관리]는 **전혀 수정하지 않음**
- 엑셀 방식 벽체타입은 **별도 모달**에서 관리
- 데이터도 **별도 테이블**에 저장 (`excelWallTypes`)

---

### 엑셀 단가표 관리 모달

**[엑셀 단가표 관리]** 버튼 클릭 시 열리는 모달:

```
┌─────────────────────────────────────────────────────────────────┐
│  엑셀 단가표 관리                                         [X]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [파일 선택...]  [업로드]   |   [전체 삭제]                     │
│                                                                 │
│  검색: [________________]                                       │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 품목      | 규격       | 두께 | 자재비  | 노무비  | 합계 │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ C-STUD   | 50형       | 50   | 7,000   | 7,000  | 14,000│   │
│  │ C-STUD   | 65형       | 65   | 7,514   | 7,000  | 14,500│   │
│  │ C-STUD   | 100형      | 100  | 9,033   | 7,833  | 16,900│   │
│  │ ...      | ...        | ...  | ...     | ...    | ...   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  총 N개 항목 | 마지막 업로드: 2025-01-14 10:30                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**기능**:
- **파일 선택/업로드**: 엑셀 파일 로드 및 저장
- **미리보기**: 업로드 전 데이터 확인 (선택 사항)
- **검색**: 품목/규격으로 필터링
- **테이블**: 저장된 일위대가 목록 표시
- **행 클릭**: 개별 항목 수정 모달
- **전체 삭제**: 모든 데이터 초기화

---

### 엑셀 벽체타입 관리 모달 (신규)

**[엑셀 벽체타입 관리]** 버튼 클릭 시 열리는 **별도 모달**:

```
┌─────────────────────────────────────────────────────────────────┐
│  엑셀 벽체타입 관리                                       [X]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [+ 새 벽체타입]                                                │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 타입명  | 골조        | 하지1       | 하지2  | 합계     │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ W-01   | C-STUD 65형 | 일반석고9.5T| -      | 19,800원 │   │
│  │ W-02   | W-STUD 124형| 방화석고19T | 도장   | 45,500원 │   │
│  │ ...    | ...         | ...         | ...    | ...      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  총 N개 벽체타입                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**벽체타입 생성/편집 서브모달**:

```
┌─────────────────────────────────────────────────────────────────┐
│  엑셀 벽체타입 편집: W-01                                 [X]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  타입명: [W-01          ]                                       │
│                                                                 │
│  레이어 구성: (엑셀 단가표에서 선택)                            │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 골조   : [▼ C-STUD 65형      ] 자재비: 7,514  노무비: 7,000│ │
│  │ 하지1  : [▼ 일반석고 9.5T*1P ] 자재비: 2,510  노무비: 2,742│ │
│  │ 하지2  : [▼ (없음)           ]                             │ │
│  │ 마감   : [▼ 도장             ] 자재비: 1,200  노무비: 800  │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  합계: 자재비 11,224원  |  노무비 10,542원  |  총 21,766원     │
│                                                                 │
│  [저장]  [취소]                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**특징**:
- 드롭다운 목록은 **오직 `importedUnitPrices` 테이블**에서만 로드
- 기존 상세 일위대가와 **완전히 분리**
- 저장 위치: **`excelWallTypes`** (별도 테이블)
- 기존 [벽체 타입 관리]는 **전혀 수정 없음**

### UI 일관성 원칙

**엑셀 벽체타입 관리 모달은 기존 벽체타입 관리 모달과 동일한 UI 구조 사용**

| 항목 | 기존 벽체타입 관리 | 엑셀 벽체타입 관리 |
|------|------------------|-------------------|
| UI 구조 | 동일 | 동일 |
| 레이아웃 | 동일 | 동일 |
| 버튼 위치 | 동일 | 동일 |
| 드롭다운 스타일 | 동일 | 동일 |
| 파일 | `unitPriceManager.js` | `excelWallTypeManager.js` (신규) |
| 드롭다운 데이터 소스 | 상세 일위대가 | `importedUnitPrices` |
| 저장 테이블 | `wallTypeMasters` | `excelWallTypes` |

**이유**:
- 사용자 혼선 최소화
- 학습 곡선 감소
- 일관된 사용자 경험 제공
- 코드만 분리, UI 경험은 동일

### 결과 페이지

두 방식 모두 **동일한 단가비교표 형식**으로 표시:

```
┌─────────────────────────────────────────────────────────────────┐
│  단가비교표                                                     │
├─────────────────────────────────────────────────────────────────┤
│  벽체타입 | 면적(㎡) | 자재비    | 노무비    | 합계           │
│  W-01    | 150.5    | 2,067,027 | 1,999,242 | 4,066,269      │
│  W-02    | 85.3     | 1,250,000 | 1,100,000 | 2,350,000      │
│  ...     | ...      | ...       | ...       | ...            │
├─────────────────────────────────────────────────────────────────┤
│  합계    | 235.8    | 3,317,027 | 3,099,242 | 6,416,269      │
└─────────────────────────────────────────────────────────────────┘
```

**발주서 처리**:
- **상세 방식 벽체타입**: 발주서 상세 표현 가능 (세부 자재별 수량)
- **엑셀 방식 벽체타입**: 발주서 상세 불가 (단가비교표만 표시)
- **혼합 프로젝트**: 상세 방식만 발주서에 포함, 엑셀 방식은 별도 표시

---

## Excel 형식 정의

### 단일 시트: 일위대가 목록

| 품목 | 규격 | 두께 | 단위 | 수량 | 자재비 | 노무비 | 합계 |
|------|------|------|------|------|--------|--------|------|
| C-STUD | 50형 | 50 | M2 | 1.00 | 7,000 | 7,000 | 14,000 |
| C-STUD | 65형 | 65 | M2 | 1.00 | 7,514 | 7,000 | 14,500 |
| C-STUD | 100형 | 100 | M2 | 1.00 | 9,033 | 7,833 | 16,900 |
| W-STUD | 124형 | 124 | M2 | 1.00 | 14,000 | 7,000 | 21,000 |
| 일반석고 취부 | 9.5T*1P | 9.5 | M2 | 1.00 | 2,510 | 2,742 | 5,300 |
| 일반석고 취부 | 12.5T*1P | 12.5 | M2 | 1.00 | 3,200 | 2,600 | 5,800 |
| 방화석고 취부 | 19T*1P | 19 | M2 | 1.00 | - | 4,500 | 4,500 |
| 방수석고 취부 | 12.5T*1P | 12.5 | M2 | 1.00 | 5,500 | 2,800 | 8,300 |
| 차음석고 취부 | 12.5T*1P | 12.5 | M2 | 1.00 | 3,800 | 3,000 | 6,800 |
| MDF | 9T | 9 | M2 | 1.00 | ... | ... | ... |
| 합판 | 9T | 9 | M2 | 1.00 | ... | ... | ... |
| 도장 | - | 0 | M2 | 1.00 | ... | ... | ... |

**핵심**: 엑셀 1row = 시스템의 1개 일위대가 (간소화 버전)

### 헤더 인식 규칙

- 첫 번째 행을 헤더로 인식
- 필수 컬럼: "품목", "규격", "자재비", "노무비"
- 선택 컬럼: "두께", "단위", "수량", "합계"
- 컬럼 순서는 유연하게 처리 (헤더명으로 매핑)

### 키 생성 규칙

```
키 = `${품목}_${규격}`.toLowerCase().replace(/\s+/g, '')
예: "C-STUD_65형" → "c-stud_65형"
예: "일반석고 취부_9.5T*1P" → "일반석고취부_9.5t*1p"
```

---

## 두 방식 비교

### 기존 방식: 상세 일위대가

```
일위대가 (예: C-STUD 65형)
├── 구성품 1: 스터드 (자재 + 소요량 + 할증률)
├── 구성품 2: 런너 (자재 + 소요량 + 할증률)
├── 구성품 3: 피스 (자재 + 소요량 + 할증률)
├── 구성품 4: 노무비 (금액)
└── ... (상세 구성품들)
```

- **저장**: 기존 일위대가 테이블
- **장점**: 세부 자재별 관리 가능, 발주서 상세 표현
- **단점**: 설정 시간 오래 걸림

### 엑셀 방식: 간소화 일위대가

```
일위대가 (예: C-STUD 65형)
├── 자재비: 7,514원/M2
├── 노무비: 7,000원/M2
└── 합계: 14,514원/M2
```

- **저장**: `importedUnitPrices` (별도 테이블)
- **장점**: 빠른 설정, 외부 단가표 직접 사용
- **단점**: 세부 자재 정보 없음, 발주서 상세 불가

### 비교표

| 항목 | 상세 일위대가 | 엑셀 일위대가 |
|------|--------------|--------------|
| 설정 시간 | 40분+ | 5분 |
| 세부 자재 정보 | O | X |
| 발주서 상세 | O | X |
| 단가비교표 | O | O |
| 외부 단가표 활용 | X | O |

---

## 벽체타입 구성 시 선택

```
벽체타입 "W-01" 생성/편집
├── 방식 선택: [엑셀 일위대가] / [상세 일위대가]
│
├── [엑셀 선택 시]
│   ├── 골조: 드롭다운 → importedUnitPrices에서 선택
│   ├── 하지1: 드롭다운 → importedUnitPrices에서 선택
│   └── ... (모든 레이어 엑셀 일위대가에서만 선택)
│
└── [상세 선택 시]
    ├── 골조: 드롭다운 → 기존 상세 일위대가에서 선택
    ├── 하지1: 드롭다운 → 기존 상세 일위대가에서 선택
    └── ... (모든 레이어 상세 일위대가에서만 선택)
```

**핵심 원칙**: 한 벽체타입 내에서는 혼합 불가

---

## 데이터 구조

### IndexedDB 테이블 1: `importedUnitPrices` (신규)

엑셀에서 업로드한 일위대가 저장

```javascript
{
  id: 'imp_123456789',           // 자동 생성 ID
  item: 'C-STUD',                // 품목
  spec: '65형',                  // 규격
  thickness: 65,                 // 두께 (mm)
  unit: 'M2',                    // 단위
  quantity: 1,                   // 수량
  materialPrice: 7514,           // 자재비
  laborPrice: 7000,              // 노무비
  totalPrice: 14514,             // 합계
  key: 'c-stud_65형',           // 검색용 키 (품목_규격)
  importedAt: '2025-01-14...',   // 가져온 시간
  updatedAt: '2025-01-14...'     // 업데이트 시간
}
```

### IndexedDB 테이블 2: `excelWallTypes` (신규)

엑셀 일위대가 기반 벽체타입 저장 (기존 wallTypeMasters와 **완전 분리**)

```javascript
{
  id: 'ewt_123456789',           // 자동 생성 ID
  name: 'W-01',                  // 타입명
  layers: {
    channel: {
      unitPriceId: 'imp_xxx',    // importedUnitPrices 참조 ID
      unitPriceKey: 'c-stud_65형',
      materialPrice: 7514,
      laborPrice: 7000
    },
    layer1: {
      unitPriceId: 'imp_yyy',
      unitPriceKey: '일반석고취부_9.5t*1p',
      materialPrice: 2510,
      laborPrice: 2742
    },
    layer2: null,                // 미사용
    finish: {
      unitPriceId: 'imp_zzz',
      unitPriceKey: '도장_-',
      materialPrice: 1200,
      laborPrice: 800
    }
  },
  totalMaterialPrice: 11224,     // 자재비 합계
  totalLaborPrice: 10542,        // 노무비 합계
  totalPrice: 21766,             // 총 합계
  totalThickness: 84.5,          // 두께 합계 (mm)
  createdAt: '2025-01-14...',
  updatedAt: '2025-01-14...'
}
```

### 기존 테이블 (변경 없음)

- `wallTypeMasters`: 기존 상세 일위대가 방식 벽체타입 (수정 없음)
- `detailUnitPrices`: 기존 상세 일위대가 (수정 없음)
- 기타 기존 테이블: 모두 수정 없음

---

## 전체 프로세스 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│  1. 엑셀 단가표 업로드 [엑셀 단가표 관리]                        │
│     - 파일 선택 → 파싱 → 미리보기 → 저장                        │
│     - 저장 위치: importedUnitPrices 테이블                       │
│     - 재업로드 시: key(품목_규격) 기준 업데이트                   │
│     - 검색, 수정, 삭제 기능                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 엑셀 벽체타입 생성 [엑셀 벽체타입 관리] - 별도 모달          │
│     - importedUnitPrices에서 일위대가 선택                       │
│     - 레이어별 구성 (골조, 하지1, 하지2, 마감)                   │
│     - 저장 위치: excelWallTypes 테이블 (기존과 완전 분리)        │
│     - 기존 [벽체 타입 관리]는 수정 없음                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. Revit 벽체타입 생성                                          │
│     - excelWallTypes 데이터 → Revit WallType 생성                │
│     - 두께 정보 활용 (totalThickness)                            │
│     - WebSocket 통신                                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. Revit 데이터 연동 및 계산                                    │
│     - Revit 벽체 → excelWallTypes 매칭                          │
│     - 면적 × 단가 = 금액 (단순 계산)                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. 결과 표시                                                    │
│     - 단가비교표 (기존 형식 유지)                                │
│     - 발주서 상세: 불가 (세부 자재 정보 없음)                    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 구현 계획 상세

### Phase 1: IndexedDB 스키마 추가

**파일**: `public/js/modules/priceDatabase.js`

- Dexie 스키마에 **2개 테이블** 추가:
  - `importedUnitPrices`: 엑셀 일위대가
  - `excelWallTypes`: 엑셀 벽체타입
- 인덱스 설정

### Phase 2: 엑셀 파싱 모듈

**파일**: `public/js/modules/excelUnitPriceImporter.js` (신규)

**주요 함수**:
- `parseUnitPriceExcel(file)`: 엑셀 파싱 (단일 시트)
- `saveImportedUnitPrices(unitPrices)`: DB 저장 (key 기준 upsert)
- `findByKey(key)`: 키로 검색
- `getAllImportedUnitPrices()`: 전체 조회
- `deleteImportedUnitPrice(id)`: 삭제
- `clearAllImportedUnitPrices()`: 전체 삭제

### Phase 3: 엑셀 단가표 관리 모달

**파일**: `public/js/modules/excelPriceManager.js` (신규)

**기능**:
- [엑셀 단가표 관리] 버튼 클릭 시 모달 표시
- 엑셀 파일 업로드/파싱/저장
- 목록 조회 (테이블 형태)
- 검색 (품목, 규격)
- 개별 항목 수정/삭제
- 전체 초기화

### Phase 4: 엑셀 벽체타입 관리 모달 (신규)

**파일**: `public/js/modules/excelWallTypeManager.js` (신규)

**기능**:
- [엑셀 벽체타입 관리] 버튼 클릭 시 **별도 모달** 표시
- 벽체타입 목록 조회
- 새 벽체타입 생성 서브모달
- 레이어별 일위대가 선택 (importedUnitPrices에서만)
- 단가 자동 합산
- `excelWallTypes` 테이블에 저장
- **기존 unitPriceManager.js는 수정 없음**

### Phase 5: Revit 벽체타입 생성

**파일**: `public/js/revit-wall-handler.js` (수정)

**변경 사항**:
- excelWallTypes 데이터 → Revit CreateWallType 명령
- 두께 정보 활용 (totalThickness)
- WebSocket 통신

### Phase 6: 계산 로직 추가

**파일**: `public/js/wall-cost-calculator.js` (수정)

**변경 사항**:
- excelWallTypes 매칭 로직 추가
- 단순 계산: 면적 × (자재비 + 노무비)
- 기존 상세 계산 로직은 **변경 없음**

### Phase 7: 단가비교표 확장

**파일**: `public/js/wall-cost-calculator.js` (수정)

**변경 사항**:
- excelWallTypes 기반 벽체도 단가비교표에 표시
- 기존 형식 유지
- 발주서 상세는 제외 (세부 자재 정보 없음)

---

## 수정할 파일 목록

| 파일 | 작업 | 설명 |
|------|------|------|
| `public/js/modules/priceDatabase.js` | 수정 | 2개 테이블 스키마 추가 |
| `public/js/modules/excelUnitPriceImporter.js` | **신규** | 엑셀 파싱 및 저장 (약 200줄) |
| `public/js/modules/excelPriceManager.js` | **신규** | 엑셀 단가표 관리 모달 (약 400줄) |
| `public/js/modules/excelWallTypeManager.js` | **신규** | 엑셀 벽체타입 관리 모달 (약 500줄) |
| `public/js/wall-cost-calculator.js` | 수정 | excelWallTypes 계산 로직 추가 (약 100줄) |
| `public/js/revit-wall-handler.js` | 수정 | Revit 벽체타입 생성 (약 50줄 추가) |
| `public/index.html` | 수정 | 버튼 2개 및 라벨 추가 |
| `public/css/styles.css` | 수정 | UI 스타일 (약 150줄 추가) |

### 수정하지 않는 파일 (완벽 분리)

| 파일 | 이유 |
|------|------|
| `public/js/modules/unitPriceManager.js` | 기존 상세 일위대가 전용 |
| `public/js/modules/materialManager.js` | 기존 자재 관리 전용 |
| 기타 기존 파일들 | 완벽 분리 원칙 |

---

## 검증 방법

### 1. 엑셀 업로드 테스트
- [엑셀 단가표 관리] 버튼 클릭 → 모달 표시
- 엑셀 파일 업로드 → importedUnitPrices 저장 확인
- 재업로드 시 업데이트 확인 (key 기준)
- 개발자도구 > Application > IndexedDB에서 확인

### 2. 엑셀 단가표 관리 테스트
- 목록 표시 확인
- 검색, 수정, 삭제 기능 확인
- 전체 삭제 기능 확인

### 3. 엑셀 벽체타입 관리 테스트
- [엑셀 벽체타입 관리] 버튼 클릭 → **별도 모달** 표시
- 새 벽체타입 생성 → 서브모달 표시
- 일위대가 선택 → 단가 자동 합산 확인
- 저장 후 excelWallTypes 테이블 확인

### 4. Revit 연동 테스트
- excelWallTypes → Revit WallType 생성 확인
- 두께 정보 반영 확인

### 5. 계산 테스트
- excelWallTypes 기반 벽체 → 단순 계산 확인
- 기존 상세 방식 벽체 → 기존 계산 정상 작동 확인

### 6. 단가비교표 테스트
- 엑셀 방식 벽체도 단가비교표에 표시 확인
- 기존 형식과 동일한지 확인

---

## 기존 기능 호환성 (완벽 분리)

### 유지되는 기존 기능 (100% 변경 없음)

| 기능 | 파일 | 상태 |
|------|------|------|
| 일위대가 수동 생성/편집 | `unitPriceManager.js` | **변경 없음** |
| 벽체 타입 수동 생성 | `unitPriceManager.js` | **변경 없음** |
| 기존 계산 로직 | `wall-cost-calculator.js` | **변경 없음** (추가만) |
| 자재 관리 | `materialManager.js` | **변경 없음** |
| Revit 연동 | `revit-wall-handler.js` | **변경 없음** (추가만) |

### 구현 원칙 (완벽 분리)

1. **기존 코드 수정 최소화**: 기존 함수 수정 없이 새 함수만 추가
2. **완전한 UI 분리**: 별도 버튼 2개, 별도 모달 2개
3. **완전한 데이터 분리**: 별도 테이블 2개 (`importedUnitPrices`, `excelWallTypes`)
4. **기존 테이블 수정 없음**: `wallTypeMasters`, `detailUnitPrices` 등 변경 없음
5. **Fallback 보장**: 엑셀 데이터 없어도 기존 방식으로 100% 동작

---

## 예상 결과

**기존 상세 일위대가 사용자**:
- 기존 워크플로우 100% 유지
- 발주서 상세 표현 가능

**엑셀 일위대가 사용자**:
- 외부 단가표 직접 사용
- 빠른 설정 (40분 → 5분)
- 단가비교표 표현 가능
- 발주서 상세는 불가 (세부 자재 정보 없음)

**두 방식 병행 사용**:
- 프로젝트별 또는 벽체타입별 선택 가능
- 데이터 충돌 없음 (별도 테이블)
