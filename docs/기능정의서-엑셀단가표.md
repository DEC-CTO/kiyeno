# 📋 기능정의서 (Functional Specification)

## 엑셀 단가표 로드 기능

---

## 1. 개요

### 1.1 문서 목적
본 문서는 Kiyeno 벽체 관리 시스템에 "엑셀 단가표 로드 기능"을 추가하기 위한 상세 기능정의서입니다.

### 1.2 기능 목적
- 외부 엑셀 단가표를 시스템에 로드하여 간소화된 일위대가로 사용
- 기존 상세 일위대가 방식과 병행 운영 가능
- Revit 연동 시 자동으로 적합한 계산 방식 적용

### 1.3 용어 정의

| 용어 | 정의 |
|------|------|
| **상세 일위대가** | 구성품(스터드, 런너, 피스 등)을 개별 등록하여 상세 단가를 산출하는 기존 방식 |
| **간소화 일위대가** | 엑셀에서 가져온 총 자재비/노무비만 사용하는 단순화 방식 |
| **벽체타입** | 레이어(골조, 하지1, 하지2, 마감)별 일위대가를 조합한 벽체 구성 단위 |
| **source 필드** | 벽체타입이 어떤 방식으로 생성되었는지 구분하는 필드 ('excel' 또는 'detailed') |

---

## 2. 화면별 상세 기능

---

### 2.1 메인 화면 (index.html)

#### 2.1.1 화면 구성 변경

**현재 상태:**
```
[자재 관리] [벽체 타입 관리] [일위대가 관리]
```

**변경 후:**
```
┌─────────────────────────────────────────────────────────────┐
│  ▸ 상세 일위대가 방식                                        │
│    [자재 관리]  [벽체 타입 관리]  [일위대가 관리]            │
├─────────────────────────────────────────────────────────────┤
│  ▸ 간소화 방식 (엑셀 단가표)                                 │
│    [엑셀 단가표 관리]                                        │
└─────────────────────────────────────────────────────────────┘
```

#### 2.1.2 신규 UI 요소

| 요소 | 유형 | 설명 |
|------|------|------|
| "상세 일위대가 방식" 라벨 | 텍스트 | 기존 버튼 3개 위에 표시되는 섹션 라벨 |
| 구분선 | 시각 요소 | 두 방식을 구분하는 수평선 |
| "간소화 방식 (엑셀 단가표)" 라벨 | 텍스트 | 신규 버튼 위에 표시되는 섹션 라벨 |
| **[엑셀 단가표 관리] 버튼** | 버튼 | 신규 추가 버튼 |

#### 2.1.3 [엑셀 단가표 관리] 버튼 동작

| 항목 | 내용 |
|------|------|
| **버튼 ID** | `btnExcelUnitPriceManagement` |
| **버튼 텍스트** | "엑셀 단가표 관리" |
| **아이콘** | `<i class="fas fa-file-excel"></i>` (Font Awesome) |
| **클릭 시 동작** | `openExcelUnitPriceModal()` 함수 호출 |
| **결과** | "엑셀 단가표 관리 모달" 표시 |

---

### 2.2 엑셀 단가표 관리 모달

#### 2.2.1 모달 기본 정보

| 항목 | 내용 |
|------|------|
| **모달 ID** | `excelUnitPriceModal` |
| **모달 제목** | "엑셀 단가표 관리" |
| **크기** | 너비 900px, 높이 자동 (최대 80vh) |
| **위치** | 화면 중앙 |
| **닫기 방법** | X 버튼만 닫기 가능 (ESC 키 비활성화 — 인라인 편집 취소와 충돌 방지) |

#### 2.2.2 모달 레이아웃

```
┌──────────────────────────────────────────────────────────────────────────────────────────┐
│  엑셀 단가표 관리                                                                  [X]  │
├──────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────────┐   │
│  │  📁 파일 업로드: [파일 선택...]  선택된 파일: (없음)  [업로드]                    │   │
│  └──────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────────┐   │
│  │  🔍 [________________검색________________]  [엑셀 내보내기] [행 추가] [전체 삭제] │   │
│  └──────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────────┐   │
│  │  📋 일위대가 목록 (2단계 그룹핑: 부위 → 품명)                                    │   │
│  │  ┌──────────────────────────────────────────────────────────────────────────────┐│   │
│  │  │ NO |부위|  품명  | 규격 |단위|두께|수량| 자재비 | 노무비 |  합계  |자재공종|노무공종││   │
│  │  ├──────────────────────────────────────────────────────────────────────────────┤│   │
│  │  │ ▸ 가설벽  ──────────────────────────────────────────── (1차 그룹 헤더)      ││   │
│  │  │   ▸ C-STUD  ──────────────────────────────────────── (2차 그룹 헤더)        ││   │
│  │  │ 1  |가설벽|C-STUD | 50형 | M2 | 50 | 1 |  7,000 |  7,000 | 14,000 |경량철골|경량철골││   │
│  │  │ 2  |가설벽|C-STUD | 65형 | M2 | 65 | 1 |  7,514 |  7,000 | 14,514 |경량철골|경량철골││   │
│  │  │ ▸ 벽  ────────────────────────────────────────────── (1차 그룹 헤더)        ││   │
│  │  │   ▸ 일반석고 취부  ────────────────────────────────── (2차 그룹 헤더)        ││   │
│  │  │ 3  | 벽 |일반석고| 9.5T | M2 |9.5 | 1 |  2,510 |  2,742 |  5,252 |석고보드|석고보드││   │
│  │  │ ...                                                                          ││   │
│  │  └──────────────────────────────────────────────────────────────────────────────┘│   │
│  │                                                                                  │   │
│  │  ※ NO 셀: 평상시 행번호 표시, 마우스 호버 시 × 삭제 버튼으로 전환               │   │
│  └──────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────────┐   │
│  │  📊 총 N개 항목 | 마지막 업로드: 2025-01-14 10:30                                │   │
│  └──────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
└──────────────────────────────────────────────────────────────────────────────────────────┘
```

> **참고**: 모달에 별도 [닫기] 버튼 없음. 오른쪽 상단 X 버튼으로만 닫기 가능.

#### 2.2.3 파일 업로드 영역 상세

##### [파일 선택...] 버튼

| 항목 | 내용 |
|------|------|
| **버튼 ID** | `btnSelectExcelFile` |
| **버튼 유형** | `<input type="file">` 스타일링 버튼 |
| **허용 파일 형식** | `.xlsx`, `.xls` |
| **클릭 시 동작** | 파일 탐색기 열기 |
| **파일 선택 후** | "선택된 파일: [파일명]" 표시, [업로드] 버튼 활성화 |

##### [업로드] 버튼

| 항목 | 내용 |
|------|------|
| **버튼 ID** | `btnUploadExcel` |
| **초기 상태** | 비활성화 (disabled) |
| **활성화 조건** | 파일이 선택된 경우 |
| **클릭 시 동작** | |
| 1. 로딩 표시 | "업로드 중..." 스피너 표시 |
| 2. 파일 파싱 | SheetJS(XLSX) 라이브러리로 엑셀 파싱 |
| 3. 데이터 검증 | 필수 컬럼 존재 여부 확인 |
| 4. 미리보기 표시 | 파싱 결과 미리보기 모달 표시 (선택사항) |
| 5. DB 저장 | `importedUnitPrices` 테이블에 upsert |
| 6. 결과 표시 | "N개 항목 저장 완료" 토스트 메시지 |
| 7. 목록 갱신 | 테이블 새로고침 |
| **오류 시** | 오류 메시지 토스트 표시 |

##### 파일 파싱 규칙

| 엑셀 컬럼 | 열 | 필수 여부 | 매핑 필드 | 데이터 유형 | 비고 |
|-----------|-----|----------|-----------|------------|------|
| 부위 | A | 선택 | `location` | 문자열 | 예: "가설벽", "벽" |
| 품명 | B | ✅ 필수 | `item` | 문자열 | 예: "C-STUD", "일반석고 취부" |
| 규격 | C | ✅ 필수 | `spec` | 문자열 | 예: "65형", "9.5T*1P" |
| 단위 | D | 선택 | `unit` | 문자열 | 기본값 "M2" |
| 두께 | E | 선택 | `thickness` | 숫자 | mm 단위, 기본값 0 |
| 수량 | F | 선택 | `quantity` | 숫자 | 기본값 1 |
| 자재비 | G | ✅ 필수 | `materialPrice` | 숫자 | 원 단위 |
| 노무비 | H | ✅ 필수 | `laborPrice` | 숫자 | 원 단위 |
| 단가 | I | 선택 | `totalPrice` | 숫자 | 없으면 자재비+노무비 |
| 자재공종 | J | 선택 | `materialWorkType` | 문자열 | 기본값 "" |
| 노무공종 | K | 선택 | `laborWorkType` | 문자열 | 기본값 "" |

##### 중복 처리 규칙

| 항목 | 내용 |
|------|------|
| **키 생성 규칙** | `key = (품명 + "_" + 규격).toLowerCase()` |
| **중복 판단** | 동일 key가 이미 존재하는 경우 |
| **중복 시 동작** | 기존 데이터 업데이트 (upsert) |
| **업데이트 필드** | 모든 필드 갱신, `updatedAt` 시간 기록 |
| **신규 추가 시** | 새 ID 생성, `importedAt` 시간 기록 |

#### 2.2.4 검색 영역 상세

##### 검색 입력창

| 항목 | 내용 |
|------|------|
| **입력창 ID** | `inputSearchExcelUnitPrice` |
| **placeholder** | "품목 또는 규격 검색..." |
| **검색 대상** | `item` (품목), `spec` (규격) 필드 |
| **검색 방식** | 실시간 필터링 (입력 즉시) |
| **대소문자 구분** | 구분 안 함 (case-insensitive) |
| **빈 값 입력 시** | 전체 목록 표시 |

##### [전체 삭제] 버튼

| 항목 | 내용 |
|------|------|
| **버튼 ID** | `btnDeleteAllExcelUnitPrices` |
| **버튼 스타일** | 빨간색 (위험 동작 표시) |
| **클릭 시 동작** | |
| 1. 확인 대화상자 | "정말 모든 엑셀 일위대가를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다." |
| 2. [확인] 클릭 시 | `importedUnitPrices` 테이블 전체 삭제 |
| 3. 결과 표시 | "모든 데이터가 삭제되었습니다" 토스트 |
| 4. 목록 갱신 | 테이블 비우기 |
| **[취소] 클릭 시** | 동작 취소, 모달 유지 |

#### 2.2.5 일위대가 목록 테이블 상세

##### 테이블 컬럼 정의

| 컬럼 | 너비 | 정렬 | 편집 가능 | 설명 |
|------|------|------|----------|------|
| NO | 36px | 중앙 | ❌ | 행 번호 (자동 생성), 호버 시 × 삭제 버튼 표시 |
| 부위 | 70px | 중앙 | ✅ | `location` 필드 (예: "가설벽", "벽") |
| 품명 | 120px | 중앙 | ✅ | `item` 필드, 편집 시 key 재생성 |
| 규격 | 100px | 중앙 | ✅ | `spec` 필드, 편집 시 key 재생성 |
| 단위 | 50px | 중앙 | ✅ | `unit` 필드 |
| 두께 | 55px | 중앙 | ✅ | `thickness` 필드 (mm), 소수점 허용 |
| 수량 | 45px | 중앙 | ✅ | `quantity` 필드 |
| 자재비 | 80px | 우측 | ✅ | `materialPrice` 천단위 콤마 |
| 노무비 | 80px | 우측 | ✅ | `laborPrice` 천단위 콤마 |
| 합계 | 90px | 우측 | ❌ | `totalPrice` 자동계산 (자재비+노무비) |
| 자재공종 | 80px | 중앙 | ✅ | `materialWorkType` 필드 |
| 노무공종 | 80px | 중앙 | ✅ | `laborWorkType` 필드 |

##### 2단계 그룹핑

| 항목 | 내용 |
|------|------|
| **1차 그룹** | 부위별 (가설벽 → 벽 → 나머지 가나다순) |
| **2차 그룹** | 품명별 (가나다순) |
| **1차 헤더 스타일** | 배경 #cbd5e1, 폰트 700, 색상 #1e293b |
| **2차 헤더 스타일** | 배경 #f1f5f9, 폰트 600, 색상 #475569, 왼쪽 패딩 28px |
| **그룹 재정렬** | 부위/품명 편집 시 자동 리렌더링 |

##### 인라인 셀 편집 (엑셀 스타일)

| 항목 | 내용 |
|------|------|
| **편집 시작** | 셀 클릭 → input 삽입 (셀 크기 고정, 내부 편집) |
| **저장** | blur 또는 Enter → DB 즉시 업데이트 |
| **취소** | Escape → 원래 값 복원 |
| **품명/규격 변경** | key 자동 재생성 + 테이블 리렌더 (그룹핑 반영) |
| **자재비/노무비 변경** | 합계 자동 재계산 |
| **편집 배경색** | #fffff0 (연노랑) |
| **두께 특수 처리** | 소수점 허용 (다른 숫자 필드는 반올림) |

##### 행 추가 기능

| 항목 | 내용 |
|------|------|
| **버튼** | 툴바의 [행 추가] 버튼 |
| **동작** | 빈 행 생성 (기본값: 새 항목, M2, 수량 1) → DB 저장 → 리렌더 |
| **자동 포커스** | 추가 후 해당 행의 품명 셀에 자동 포커스 |
| **그룹 배치** | 부위/품명 편집 시 자동으로 해당 그룹으로 이동 |

##### 행 삭제 기능 (NO 컬럼 통합)

| 항목 | 내용 |
|------|------|
| **동작** | NO 셀 호버 시 행번호 → × 삭제 버튼 전환 |
| **× 스타일** | 빨간색 (#ef4444), 굵게, 커서 pointer |
| **클릭 시** | 확인 대화상자 → DB 삭제 → 행 제거 → 번호 재정렬 |
| **확인 메시지** | "[품명 규격]을(를) 삭제하시겠습니까?" |

#### 2.2.6 상태 표시줄 상세

| 표시 항목 | 형식 | 예시 |
|----------|------|------|
| 총 항목 수 | "총 N개 항목" | "총 45개 항목" |
| 마지막 업로드 | "마지막 업로드: YYYY-MM-DD HH:MM" | "마지막 업로드: 2025-01-14 10:30" |
| 검색 결과 | "검색 결과: N개" (검색 시) | "검색 결과: 5개" |

---

### 2.3 인라인 셀 편집 (별도 수정 모달 없음)

> **변경**: 별도 수정 모달 대신 엑셀 스타일의 인라인 셀 편집 방식으로 구현됨.

#### 2.3.1 편집 방식

| 항목 | 내용 |
|------|------|
| **편집 방식** | 셀 직접 클릭 → input 삽입 → 편집 → blur/Enter 저장 |
| **편집 가능 필드** | 부위, 품명, 규격, 단위, 두께, 수량, 자재비, 노무비, 자재공종, 노무공종 |
| **편집 불가 필드** | NO (행번호), 합계 (자동계산) |
| **셀 크기** | 편집 시 셀 크기 고정 (크기 변동 없음) |
| **편집 배경색** | #fffff0 (연노랑) |

#### 2.3.2 특수 동작

| 필드 | 특수 동작 |
|------|----------|
| **품명/규격** | 편집 시 key 자동 재생성 (`(품명_규격).toLowerCase()`) + 그룹핑 리렌더 |
| **부위** | 편집 시 1차 그룹핑 리렌더 |
| **자재비/노무비** | 변경 시 합계 자동 재계산 |
| **두께** | 소수점 허용 (다른 숫자 필드는 정수 반올림) |

#### 2.3.3 키보드 동작

| 키 | 동작 |
|-----|------|
| **Enter** | 편집 완료 및 DB 저장 |
| **Escape** | 편집 취소 (원래 값 복원) |
| **Escape (모달)** | 모달 닫기 비활성화 — X 버튼만 닫기 가능 |

---

### 2.4 벽체 타입 관리 모달 (기존 수정)

#### 2.4.1 변경 개요

기존 벽체타입 편집 모달에 **"단가 방식" 선택 드롭다운**을 추가합니다.

#### 2.4.2 변경된 모달 레이아웃

```
┌─────────────────────────────────────────────────────────────────┐
│  벽체 타입 편집: W-01                                      [X]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  타입명: [W-01______________]                                   │
│                                                                 │
│  ★ 단가 방식: [▼ 상세 일위대가        ]  ← 신규 추가           │
│               ├── 상세 일위대가                                 │
│               └── 엑셀 일위대가 (간소화)                        │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  레이어 구성:                                                   │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 골조   : [▼ C-STUD 65형       ] 자재비: 7,514  노무비: 7,000│ │
│  │ 하지1  : [▼ 일반석고 9.5T*1P  ] 자재비: 2,510  노무비: 2,742│ │
│  │ 하지2  : [▼ (선택 안 함)       ] 자재비: -      노무비: -    │ │
│  │ 마감   : [▼ 도장              ] 자재비: 1,200  노무비: 800  │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  합계: 자재비 11,224원  |  노무비 10,542원  |  총 21,766원     │
│                                                                 │
│                                              [취소]  [저장]     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.4.3 단가 방식 드롭다운 상세

| 항목 | 내용 |
|------|------|
| **드롭다운 ID** | `selectWallTypeSource` |
| **옵션 1** | "상세 일위대가" (value: `detailed`) |
| **옵션 2** | "엑셀 일위대가 (간소화)" (value: `excel`) |
| **기본값** | "상세 일위대가" (기존 호환성) |

#### 2.4.4 단가 방식 변경 시 동작

| 동작 순서 | 내용 |
|----------|------|
| 1. 경고 표시 | "단가 방식을 변경하면 기존 레이어 선택이 초기화됩니다. 계속하시겠습니까?" |
| 2. [확인] 시 | 모든 레이어 드롭다운 초기화 |
| 3. 데이터 로드 | 선택한 방식에 따라 드롭다운 옵션 변경 |
| 4. [취소] 시 | 방식 변경 취소, 기존 상태 유지 |

#### 2.4.5 레이어 드롭다운 데이터 소스

| 단가 방식 | 데이터 소스 | 옵션 형식 |
|----------|------------|----------|
| **상세 일위대가** | 기존 일위대가 테이블 | "[세부아이템명] - [품목] [규격]" |
| **엑셀 일위대가** | `importedUnitPrices` 테이블 | "[품목] [규격] (₩[합계])" |

#### 2.4.6 레이어 드롭다운 선택 시 동작

| 동작 순서 | 내용 |
|----------|------|
| 1. 선택 감지 | 드롭다운에서 일위대가 선택 |
| 2. 단가 표시 | 해당 레이어 행에 자재비, 노무비 표시 |
| 3. 합계 갱신 | 하단 합계 자동 재계산 |

#### 2.4.7 저장 시 추가 동작

| 항목 | 내용 |
|------|------|
| **저장되는 추가 필드** | `source: 'excel'` 또는 `source: 'detailed'` |
| **레이어 데이터 구조** | 방식에 따라 다름 (아래 참조) |

##### 엑셀 방식 레이어 데이터 구조:
```javascript
{
  channel: {
    unitPriceId: 'imp_xxx',           // importedUnitPrices ID
    unitPriceKey: 'c-stud_65형',      // 검색용 키
    materialPrice: 7514,
    laborPrice: 7000
  },
  // ... 다른 레이어
}
```

##### 상세 방식 레이어 데이터 구조:
```javascript
{
  channel: {
    unitPriceItemId: 'up_xxx',        // 기존 일위대가 ID
    // ... 기존 구조 유지
  },
  // ... 다른 레이어
}
```

---

### 2.5 Revit 벽체 데이터 확인 탭 (기존 유지)

#### 2.5.1 변경 없음

Revit 연동 탭의 UI는 변경되지 않습니다.

#### 2.5.2 [계산하기] 버튼 동작 변경

| 항목 | 기존 동작 | 변경 후 동작 |
|------|----------|-------------|
| **버튼 클릭** | 모든 벽체에 상세 계산 적용 | 벽체타입별 source 확인 후 분기 |
| **계산 로직** | 단일 로직 | 자동 감지 후 적합한 로직 적용 |

#### 2.5.3 자동 감지 계산 흐름

```
[계산하기] 버튼 클릭
        │
        ▼
각 벽체에 대해 반복:
        │
        ├─→ wallTypeMasters에서 타입명 검색
        │
        ├─→ 매칭 실패 → "미매칭" 처리, 다음 벽체로
        │
        └─→ 매칭 성공 → source 필드 확인
                    │
                    ├─→ source: 'excel' (또는 undefined → 'detailed')
                    │           │
                    │           └─→ 간소화 계산:
                    │                 materialCost = 면적 × totalMaterialPrice
                    │                 laborCost = 면적 × totalLaborPrice
                    │                 totalCost = 면적 × totalPrice
                    │
                    └─→ source: 'detailed'
                                │
                                └─→ 상세 계산:
                                      기존 복잡한 계산 로직 그대로 실행
```

---

### 2.6 계산 결과 화면

#### 2.6.1 단가비교표 탭

| 항목 | 변경 여부 | 내용 |
|------|----------|------|
| **UI** | 변경 없음 | 기존 단가비교표 형식 유지 |
| **데이터** | 호환 | 엑셀 방식도 동일하게 표시 |
| **필요 필드** | 제공됨 | materialUnitPrice, laborUnitPrice, unitPrice |

#### 2.6.2 발주서 탭

| 항목 | 변경 여부 | 내용 |
|------|----------|------|
| **UI** | 일부 변경 | 엑셀 방식 벽체 알림 영역 추가 |
| **상세 방식 벽체** | 기존대로 | 구성품별 상세 표시 |
| **엑셀 방식 벽체** | 제외 + 알림 | 발주서에서 제외, 상단에 알림 표시 |

##### 엑셀 방식 벽체 알림 UI:

```
┌─────────────────────────────────────────────────────────────────┐
│  ⚠️ 엑셀 단가 적용 벽체 (발주서 미지원)                          │
│  다음 벽체는 상세 구성품 정보가 없어 발주서에 포함되지 않습니다:  │
│  - W-01: 150.5㎡, 2,067,027원                                   │
│  - W-03: 85.3㎡, 1,250,000원                                    │
│  (단가비교표에서 금액 확인 가능)                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.6.3 견적서 탭

| 항목 | 변경 여부 | 내용 |
|------|----------|------|
| **갑지 (표지)** | 변경 없음 | 총 금액 표시 (엑셀 방식 포함) |
| **을지 (내역서)** | 변경 없음 | 합계만 표시 (구성품 상세 없음) |

---

### 2.7 Excel 내보내기 기능

#### 2.7.1 단가비교표 Excel 내보내기

| 항목 | 내용 |
|------|------|
| **버튼** | [Excel 내보내기] (기존) |
| **변경 여부** | 변경 없음 |
| **엑셀 방식 호환** | ✅ 완전 호환 |

#### 2.7.2 발주서 Excel 내보내기

| 항목 | 내용 |
|------|------|
| **버튼** | [발주서 Excel 내보내기] (기존) |
| **변경 내용** | 엑셀 방식 벽체 제외 처리 |
| **엑셀 방식 호환** | ❌ 미호환 (제외됨) |
| **알림 표시** | Excel 파일에 별도 시트로 미지원 벽체 목록 포함 (선택사항) |

#### 2.7.3 견적서 Excel 내보내기

| 항목 | 내용 |
|------|------|
| **버튼** | [견적서 Excel 내보내기] (기존) |
| **변경 여부** | 변경 없음 |
| **엑셀 방식 호환** | ✅ 완전 호환 (금액 합산에 포함) |

---

## 3. 데이터베이스 스키마

### 3.1 신규 테이블: importedUnitPrices

| 필드명 | 타입 | 인덱스 | 필수 | 엑셀 열 | 설명 |
|--------|------|--------|------|---------|------|
| `id` | string | ✅ PK | ✅ | - | 자동 생성 ID (예: "imp_1705234567890") |
| `key` | string | ✅ | ✅ | - | 검색용 키 (품명_규격 소문자) |
| `location` | string | ✅ | | A | 부위 (예: "가설벽", "벽") |
| `item` | string | ✅ | ✅ | B | 품명 (예: "C-STUD", "일반석고 취부") |
| `spec` | string | ✅ | ✅ | C | 규격 (예: "65형", "9.5T*1P") |
| `unit` | string | | | D | 단위 (기본값: "M2") |
| `thickness` | number | | | E | 두께 (mm) |
| `quantity` | number | | | F | 수량 (기본값: 1) |
| `materialPrice` | number | | ✅ | G | 자재비 |
| `laborPrice` | number | | ✅ | H | 노무비 |
| `totalPrice` | number | | | I | 단가 (없으면 자재비+노무비) |
| `materialWorkType` | string | | | J | 자재공종 |
| `laborWorkType` | string | | | K | 노무공종 |
| `importedAt` | string | ✅ | ✅ | - | 최초 가져온 시간 (ISO 8601) |
| `updatedAt` | string | | | - | 마지막 업데이트 시간 |

### 3.2 기존 테이블 확장: wallTypeMasters

| 추가 필드 | 타입 | 필수 | 기본값 | 설명 |
|----------|------|------|--------|------|
| `source` | string | | 'detailed' | 단가 방식 ('excel' 또는 'detailed') |

---

## 4. 오류 처리

### 4.1 파일 업로드 오류

| 오류 상황 | 오류 메시지 | 처리 방법 |
|----------|------------|----------|
| 파일 형식 불일치 | "지원하지 않는 파일 형식입니다. .xlsx 또는 .xls 파일을 선택해주세요." | 토스트 표시 |
| 파일 읽기 실패 | "파일을 읽을 수 없습니다. 파일이 손상되었을 수 있습니다." | 토스트 표시 |
| 필수 컬럼 누락 | "필수 컬럼(품목, 규격, 자재비, 노무비)이 누락되었습니다." | 토스트 표시 |
| 데이터 없음 | "유효한 데이터가 없습니다. 엑셀 파일을 확인해주세요." | 토스트 표시 |

### 4.2 저장 오류

| 오류 상황 | 오류 메시지 | 처리 방법 |
|----------|------------|----------|
| DB 저장 실패 | "데이터 저장에 실패했습니다. 다시 시도해주세요." | 토스트 표시, 로그 기록 |
| 유효성 검사 실패 | "[필드명]이(가) 올바르지 않습니다." | 해당 필드 하이라이트 |

### 4.3 계산 오류

| 오류 상황 | 오류 메시지 | 처리 방법 |
|----------|------------|----------|
| 벽체타입 미매칭 | "미매칭" 표시 | 결과 테이블에 미매칭으로 표시 |
| 일위대가 데이터 없음 | "일위대가 데이터를 찾을 수 없습니다: [타입명]" | 해당 벽체 건너뛰기, 로그 기록 |

---

## 5. 보안 및 유효성 검사

### 5.1 입력값 검증

| 검증 항목 | 검증 규칙 | 적용 시점 |
|----------|----------|----------|
| 숫자 필드 | 0 이상의 정수 | 입력 시, 저장 시 |
| 문자열 필드 | 빈 문자열 불가 (필수 필드) | 저장 시 |
| 파일 크기 | 최대 10MB | 업로드 시 |

### 5.2 XSS 방지

| 항목 | 방법 |
|------|------|
| 사용자 입력 표시 | HTML 이스케이프 처리 |
| 엑셀 데이터 | 파싱 후 문자열 정제 |

---

## 6. 성능 고려사항

### 6.1 대용량 데이터 처리

| 항목 | 제한/처리 방법 |
|------|---------------|
| 최대 행 수 | 10,000행 (권장), 초과 시 경고 |
| 배치 저장 | 100개씩 트랜잭션 처리 |
| 목록 표시 | 가상 스크롤 또는 페이지네이션 |

### 6.2 검색 최적화

| 항목 | 방법 |
|------|------|
| 인덱스 | `key`, `item`, `spec` 필드에 인덱스 |
| 디바운스 | 검색 입력 300ms 디바운스 |

---

## 7. 핵심 변경사항 요약

| 항목 | 내용 |
|------|------|
| 엑셀 구조 | **1탭만** (일위대가 목록) |
| 엑셀 일위대가 저장 | `importedUnitPrices` 테이블 (신규) |
| 벽체타입 저장 | `wallTypeMasters` 테이블 (기존) + **source 필드 추가** |
| 방식 구분 | `source: 'excel'` 또는 `source: 'detailed'` |
| 이름 충돌 방지 | 단일 테이블이라 자동 방지 |
| 자동 감지 | source 필드로 계산 로직 분기 |

---

## 8. Excel 내보내기 호환성 요약

| 기능 | 상세 방식 | 엑셀 방식 | 비고 |
|------|----------|----------|------|
| **단가비교표** | ✅ 완전 호환 | ✅ 완전 호환 | 단위당 단가만 필요 |
| **발주서** | ✅ 완전 호환 | ❌ 미호환 | 구성품 상세 필요 |
| **견적서 갑지** | ✅ 완전 호환 | ✅ 완전 호환 | 총 금액만 필요 |
| **견적서 을지** | ✅ 완전 호환 | ⚠️ 부분 호환 | 합계만 표시 |

---

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | 엑셀 단가표 로드 기능 기능정의서 |
| 버전 | 1.0 |
| 작성일 | 2025-01-14 |
| 프로젝트 | Kiyeno 벽체 관리 시스템 |
