# 엑셀 단가표 로드 기능 구현 계획

## 개요

외부 엑셀 단가표를 로드하여 간소화된 일위대가로 저장하고, 기존 상세 일위대가 방식과 **완벽 분리**하여 병행 운영하는 시스템 구현.

**핵심 원칙**: 기존 코드 수정 최소화, 별도 모듈/테이블/UI로 완전 분리

---

## 단계별 구현 태스크

### Phase 1: 메인 화면 UI 변경

**파일**: `public/index.html` (라인 94-120), `public/css/styles.css`

**작업 내용**:
1. 기존 3개 버튼 위에 "일위대가 방식" 섹션 라벨 추가
2. 구분선 추가
3. "간소화 방식 (엑셀 단가표)" 섹션 라벨 추가
4. 2개 신규 버튼 추가:
   - `[엑셀 단가표 관리]` (id: `btnExcelUnitPriceManagement`, 아이콘: `fa-file-excel`)
   - `[엑셀 벽체타입 관리]` (id: `btnExcelWallTypeManagement`, 아이콘: `fa-th-list`)
5. CSS 스타일링 (섹션 라벨, 구분선, 버튼 색상)

**현재 구조** (index.html:94-120):
```html
<button class="btn btn-green" id="materialManageBtn">자재 관리</button>
<button class="btn btn-purple" id="wallTypeManageBtn">벽체 타입 관리</button>
<button class="btn btn-orange" id="unitPriceManageBtn">일위대가 관리</button>
```

**변경 후 구조**:
```
▸ 일위대가 방식
  [자재 관리]  [벽체 타입 관리]  [일위대가 관리]
─────────────────────────────────────────────
▸ 간소화 방식 (엑셀 단가표)
  [엑셀 단가표 관리]  [엑셀 벽체타입 관리]
```

---

### Phase 2: IndexedDB 스키마 업그레이드 (v3 → v4)

**파일**: `public/js/modules/priceDatabase.js` (라인 88, 96-141), `public/js/modules/unitPriceManager.js` (라인 19, 39-83)

**작업 내용**:
1. DB 버전 3 → 4로 업그레이드
2. 2개 신규 테이블 추가:

**테이블 1: `importedUnitPrices`**
```javascript
// 엑셀에서 가져온 간소화 일위대가
{
  id: 'imp_1705234567890',       // PK
  key: 'c-stud_65형',           // 인덱스 (품목_규격 소문자)
  item: 'C-STUD',               // 인덱스 - 품목
  spec: '65형',                 // 인덱스 - 규격
  thickness: 65,                // 두께 (mm)
  unit: 'M2',                   // 단위
  quantity: 1,                  // 수량
  materialPrice: 7514,          // 자재비
  laborPrice: 7000,             // 노무비
  totalPrice: 14514,            // 합계
  importedAt: 'ISO8601',        // 인덱스 - 최초 가져온 시간
  updatedAt: 'ISO8601'          // 마지막 업데이트 시간
}
```

**테이블 2: `excelWallTypes`**
```javascript
// 엑셀 일위대가 기반 벽체타입
{
  id: 'ewt_1705234567890',      // PK
  name: 'W-01',                 // 인덱스 - 타입명
  layers: {
    channel: { unitPriceId, unitPriceKey, materialPrice, laborPrice },
    layer1: { ... },
    layer2: null,
    finish: { ... }
  },
  totalMaterialPrice: 11224,
  totalLaborPrice: 10542,
  totalPrice: 21766,
  totalThickness: 84.5,
  createdAt: 'ISO8601',         // 인덱스
  updatedAt: 'ISO8601'
}
```

**주의**: `priceDatabase.js`(라인 88)와 `unitPriceManager.js`(라인 19) **둘 다** 동일한 DB를 열므로, 양쪽 모두 버전을 4로 변경하고 v4 업그레이드 핸들러 추가 필요.

---

### Phase 3: 엑셀 파싱 모듈

**파일**: `public/js/modules/excelUnitPriceImporter.js` (신규)

**작업 내용**:
1. SheetJS(XLSX) 라이브러리를 사용한 엑셀 파싱
2. 헤더 인식 (품목, 규격, 두께, 단위, 수량, 자재비, 노무비, 합계)
3. 키 생성: `key = (품목 + "_" + 규격).toLowerCase().replace(/\s+/g, '')`
4. DB 저장 (upsert: 동일 key 존재 시 업데이트)
5. CRUD 함수:
   - `parseUnitPriceExcel(file)` → 파싱된 데이터 배열 반환
   - `saveImportedUnitPrices(unitPrices)` → DB upsert
   - `getAllImportedUnitPrices()` → 전체 조회
   - `getImportedUnitPriceByKey(key)` → 키로 조회
   - `updateImportedUnitPrice(id, data)` → 수정
   - `deleteImportedUnitPrice(id)` → 삭제
   - `clearAllImportedUnitPrices()` → 전체 삭제

**의존성**: SheetJS (이미 index.html에 포함됨)

---

### Phase 4: 엑셀 단가표 관리 모달

**파일**: `public/js/modules/excelPriceManager.js` (신규)

**작업 내용**:
1. `openExcelUnitPriceModal()` → 메인 모달 (createSubModal 사용)
2. 모달 레이아웃:
   - 파일 업로드 영역 (파일선택 + 업로드 버튼)
   - 검색 입력창 (실시간 필터링, 디바운스 300ms)
   - 일위대가 목록 테이블 (NO, 품목, 규격, 두께, 자재비, 노무비, 합계, 관리)
   - 상태 표시줄 (총 N개 항목, 마지막 업로드 시간)
3. 행 클릭 → 수정 서브모달 (품목/규격 읽기전용, 나머지 수정 가능)
4. 각 행 삭제 버튼 + 전체 삭제 버튼
5. XSS 방지: HTML 이스케이프 처리

**모달 패턴**: 기존 `openUnitPriceManagement()` (unitPriceManager.js:494-573) 패턴 참조

---

### Phase 5: 엑셀 벽체타입 관리 모달

**파일**: `public/js/modules/excelWallTypeManager.js` (신규)

**작업 내용**:
1. `openExcelWallTypeModal()` → 메인 모달
2. 벽체타입 목록 테이블 (타입명, 골조, 하지1, 하지2, 마감, 합계, 관리)
3. [+ 새 벽체타입] 버튼 → 편집 서브모달
4. 편집 서브모달:
   - 타입명 입력
   - 4개 레이어 드롭다운 (골조, 하지1, 하지2, 마감)
   - 드롭다운 데이터: `importedUnitPrices` 테이블에서만 로드
   - 선택 시 자재비/노무비 자동 표시
   - 하단 합계 자동 계산
5. CRUD: 생성, 수정, 삭제
6. `excelWallTypes` 테이블에 저장

**UI 일관성**: 기존 벽체타입 관리 모달(`revitTypeMatching.js`)과 동일한 레이아웃/스타일

---

### Phase 6: 계산 로직 확장

**파일**: `public/js/wall-cost-calculator.js`

**작업 내용**:
1. `findMatchingWallType()` (라인 228-291) 수정:
   - 기존 `wallTypeMasters` 검색 후 미매칭 시 `excelWallTypes`도 검색
   - 매칭 결과에 `source: 'excel'` 또는 `source: 'detailed'` 표시
2. `calculateSingleWallCost()` (라인 172-223) 수정:
   - `source === 'excel'` 인 경우 간소화 계산:
     ```
     materialCost = 면적 × totalMaterialPrice
     laborCost = 면적 × totalLaborPrice
     totalCost = 면적 × totalPrice
     ```
   - `source === 'detailed'` 인 경우 기존 계산 로직 그대로
3. 기존 상세 계산 로직은 **변경 없음** (추가만)

---

### Phase 7: 단가비교표 확장

**파일**: `public/js/wall-cost-calculator.js`

**작업 내용**:
1. `renderComparisonResults()` (라인 1443-1526):
   - excelWallTypes 기반 벽체도 동일 형식으로 표시
   - 자재비/노무비/합계 컬럼 표시
2. 발주서 처리:
   - 엑셀 방식 벽체는 발주서에서 제외
   - 상단에 알림 영역 표시 (어떤 벽체가 제외되었는지)
3. 견적서: 엑셀 방식 금액도 총합계에 포함

---

## index.html에 스크립트 로드 추가

**파일**: `public/index.html`

3개 신규 JS 파일을 `<script>` 태그로 추가:
```html
<script src="/js/modules/excelUnitPriceImporter.js"></script>
<script src="/js/modules/excelPriceManager.js"></script>
<script src="/js/modules/excelWallTypeManager.js"></script>
```

---

## 수정 파일 목록 요약

| 파일 | 작업 | Phase |
|------|------|-------|
| `public/index.html` | 버튼 2개 + 라벨 추가, 스크립트 로드 | 1 |
| `public/css/styles.css` | 섹션 라벨/구분선 스타일 | 1 |
| `public/js/modules/priceDatabase.js` | DB v4 업그레이드, 2개 테이블 추가 | 2 |
| `public/js/modules/unitPriceManager.js` | DB 버전 4로 변경, v4 핸들러 추가 | 2 |
| `public/js/modules/excelUnitPriceImporter.js` | **신규** - 엑셀 파싱/DB CRUD | 3 |
| `public/js/modules/excelPriceManager.js` | **신규** - 엑셀 단가표 관리 모달 | 4 |
| `public/js/modules/excelWallTypeManager.js` | **신규** - 엑셀 벽체타입 관리 모달 | 5 |
| `public/js/wall-cost-calculator.js` | 계산 분기 + 비교표 확장 | 6, 7 |

## 수정하지 않는 파일 (완벽 분리)

| 파일 | 이유 |
|------|------|
| `unitPriceManager.js` (일위대가 관리 로직) | 기존 상세 일위대가 전용 |
| `materialManager.js` | 기존 자재 관리 전용 |
| `revitTypeMatching.js` | 기존 벽체타입 관리 전용 |

---

## 검증 방법

1. **UI 테스트**: 메인 화면에서 섹션 라벨과 5개 버튼 정상 표시 확인
2. **엑셀 업로드 테스트**: 엑셀 파일 업로드 → importedUnitPrices 저장 → 재업로드 시 upsert 확인
3. **단가표 관리 테스트**: 목록 표시, 검색, 수정, 삭제, 전체 삭제
4. **벽체타입 관리 테스트**: 생성, 레이어 선택, 합계 자동 계산, 저장
5. **계산 테스트**: 엑셀 방식 벽체 간소화 계산 + 기존 상세 방식 정상 작동
6. **비교표 테스트**: 두 방식 벽체 모두 단가비교표에 표시
7. **IndexedDB 확인**: 개발자도구 > Application > IndexedDB에서 2개 신규 테이블 데이터 확인
